[env]
PROJECT_NAME = "{{ cwd | basename }}"
_.file = ".env"

[tools]
python = "{{ get_env(name='PYTHON_VERSION', default='3.10') }}"
uv = "0.8"

# === SETUP ===
[tasks.setup]
description = "Set up local environment (install dependencies)"
run = "uv sync --all-extras"
sources = ["pyproject.toml"]
outputs = [".venv"]

# === TESTING ===
[tasks.test]
alias = "tests"
description = "Run unit tests"
run = "uv run pytest --disable-socket --allow-unix-socket -v --tb=auto -rA --durations=10 -p no:logging tests/"

[tasks."test:unit"]
alias = ["unit_test", "unit_tests"]
description = "Run unit tests"
run = "uv run pytest -v --tb=auto -rA --durations=10 -p no:logging tests/unit_tests/"

[tasks."test:integration"]
alias = ["integration_test", "integration_tests"]
description = "Run integration tests"
run = "uv run pytest -v --tb=auto -rA --durations=10 -p no:logging tests/integration_tests/"

[tasks."test:watch"]
description = "Run tests in watch mode"
run = "uv run ptw --snapshot-update --now . -- -vv --tb=auto -rA --durations=10 -p no:logging tests/"

[tasks."test:all"]
description = "Run all tests and lint fixes"
run = """
mise run test
mise run lint:fix
mise run lint:mypy
"""

# === LINTING (Public) ===
[tasks.lint]
description = "Run all linters"
depends = ["lint:ruff", "lint:format:check", "lint:mypy"]

[tasks."lint:diff"]
description = "Run linters on changed files"
run = """
#!/usr/bin/env bash
PYTHON_FILES=$(git diff --relative --name-only --diff-filter=d master | grep -E '\\.py$|\\.ipynb$' || true)
if [ -n "$PYTHON_FILES" ]; then
  uv run ruff check $PYTHON_FILES
  uv run ruff format $PYTHON_FILES --diff
  mkdir -p .mypy_cache && uv run mypy $PYTHON_FILES --cache-dir .mypy_cache
fi
"""

[tasks."lint:package"]
description = "Run linters on package files"
run = """
uv run ruff check langchain_glean
uv run ruff format langchain_glean --diff
mkdir -p .mypy_cache && uv run mypy langchain_glean --cache-dir .mypy_cache
"""

[tasks."lint:tests"]
description = "Run linters on test files"
run = """
uv run ruff check tests
uv run ruff format tests --diff
mkdir -p .mypy_cache_test && uv run mypy tests --cache-dir .mypy_cache_test
"""

[tasks."lint:fix"]
description = "Run lint autofixers"
run = """
mise run lint:fix:ruff
mise run format
"""

[tasks."lint:fix:diff"]
description = "Run lint autofixers on changed files"
run = """
#!/usr/bin/env bash
PYTHON_FILES=$(git diff --relative --name-only --diff-filter=d master | grep -E '\\.py$|\\.ipynb$' || true)
if [ -n "$PYTHON_FILES" ]; then
  uv run ruff check $PYTHON_FILES --fix
  uv run ruff format $PYTHON_FILES
  uv run ruff check --select I --fix $PYTHON_FILES
fi
"""

[tasks."lint:fix:package"]
description = "Run lint autofixers on package files"
run = """
uv run ruff check langchain_glean --fix
uv run ruff format langchain_glean
uv run ruff check --select I --fix langchain_glean
"""

[tasks."lint:fix:tests"]
description = "Run lint autofixers on test files"
run = """
uv run ruff check tests --fix
uv run ruff format tests
uv run ruff check --select I --fix tests
"""

# === LINTING (Internal) ===
[tasks."lint:ruff"]
hide = true
run = "uv run ruff check . --exclude docs/ --exclude tests/"

[tasks."lint:format:check"]
hide = true
run = "uv run ruff format . --diff"

[tasks."lint:mypy"]
hide = true
run = "mkdir -p .mypy_cache && uv run mypy . --cache-dir .mypy_cache --exclude docs/ --exclude tests/"

[tasks."lint:fix:ruff"]
hide = true
run = "uv run ruff check . --fix --exclude docs/ --exclude tests/"

# === FORMATTING ===
[tasks.format]
description = "Run code formatters"
run = """
mise run format:ruff
mise run format:imports
"""

[tasks."format:diff"]
description = "Run formatters on changed files"
run = """
#!/usr/bin/env bash
PYTHON_FILES=$(git diff --relative --name-only --diff-filter=d master | grep -E '\\.py$|\\.ipynb$' || true)
if [ -n "$PYTHON_FILES" ]; then
  uv run ruff format $PYTHON_FILES
  uv run ruff check --select I --fix $PYTHON_FILES
fi
"""

[tasks."format:ruff"]
hide = true
run = "uv run ruff format ."

[tasks."format:imports"]
hide = true
run = "uv run ruff check --select I --fix ."

# === SPELLING ===
[tasks."spell:check"]
description = "Check spelling"
run = "uv run codespell --toml pyproject.toml --skip=docs/"

[tasks."spell:fix"]
description = "Fix spelling"
run = "uv run codespell --toml pyproject.toml -w --skip=docs/"

# === UTILITIES ===
[tasks."check:imports"]
description = "Check imports"
run = "find langchain_glean -name '*.py' | grep -v 'docs/' | xargs uv run python ./scripts/check_imports.py"

[tasks.release]
description = "Bump version and create a new tag (use DRY_RUN=true for preview)"
run = """
#!/usr/bin/env bash
DRY_RUN="${DRY_RUN:-false}"
CZ="uv run python -m commitizen"
if [ "$DRY_RUN" = "true" ]; then
  $CZ bump --dry-run
  $CZ changelog --dry-run
else
  $CZ bump --yes
  $CZ changelog
fi
"""
